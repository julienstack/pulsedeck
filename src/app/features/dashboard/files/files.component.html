<p-toast />
<p-confirmDialog />

<div class="p-2 md:p-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h1 class="text-xl md:text-3xl font-bold text-[var(--color-text)]">Dateien</h1>
            <p class="text-[var(--color-text-muted)] text-sm hidden md:block">Dokumente hochladen und verwalten</p>
        </div>
        <div class="flex items-center gap-2">
            <!-- Search -->
            <div class="relative">
                <i
                    class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--color-text-muted)] text-sm"></i>
                <input type="text" pInputText [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
                    (keyup.enter)="onSearch()" placeholder="Suchen..."
                    class="pl-9 pr-8 py-2 w-48 md:w-64 text-sm bg-[var(--color-surface-raised)] border-[var(--color-border)]" />
                @if (searchQuery()) {
                <button (click)="clearSearch()"
                    class="absolute right-2 top-1/2 -translate-y-1/2 text-[var(--color-text-muted)] hover:text-[var(--color-text)]">
                    <i class="pi pi-times text-xs"></i>
                </button>
                }
            </div>
            <p-button label="Hochladen" icon="pi pi-upload" severity="danger" [raised]="true" size="small"
                (click)="openUploadDialog()"></p-button>
        </div>
    </div>

    <!-- Breadcrumbs -->
    @if (!isSearching()) {
    <div class="flex items-center gap-2 mb-4 text-sm">
        @for (crumb of getBreadcrumbs(); track crumb.path; let last = $last) {
        <button (click)="navigateToFolder(crumb.path)"
            class="text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors"
            [class.font-semibold]="last" [class.text-[var(--color-text)]]="last">
            {{ crumb.label }}
        </button>
        @if (!last) {
        <i class="pi pi-chevron-right text-[var(--color-text-muted)] text-xs"></i>
        }
        }

        @if (fileService.currentFolder() !== '/') {
        <button (click)="navigateUp()"
            class="ml-4 text-xs text-[var(--color-text-muted)] hover:text-[var(--color-text)]"
            pTooltip="Eine Ebene hoch">
            <i class="pi pi-arrow-up mr-1"></i>Zurück
        </button>
        }
    </div>
    }

    <!-- Search Results Header -->
    @if (isSearching()) {
    <div class="flex items-center gap-2 mb-4">
        <i class="pi pi-search text-[var(--color-text-muted)]"></i>
        <span class="text-[var(--color-text-muted)] text-sm">
            {{ searchResults().length }} Ergebnis(se) für "{{ searchQuery() }}"
        </span>
        <button (click)="clearSearch()" class="text-xs text-linke hover:underline ml-2">
            Suche beenden
        </button>
    </div>
    }

    <!-- Loading -->
    @if (fileService.loading()) {
    <div class="flex justify-center items-center py-16">
        <p-progressSpinner strokeWidth="4" ariaLabel="Lade Dateien..." />
    </div>
    }

    <!-- Files Grid -->
    @if (!fileService.loading()) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        @for (file of (isSearching() ? searchResults() : fileService.files()); track file.id) {
        <div
            class="bg-[var(--color-surface-card)] rounded-xl border border-[var(--color-border)] p-4 hover:border-linke/50 hover:shadow-lg transition-all group">
            <!-- File Icon + Name -->
            <div class="flex items-start gap-3 mb-3">
                <div
                    class="w-10 h-10 rounded-lg bg-[var(--color-surface-raised)] flex items-center justify-center flex-shrink-0">
                    <i
                        class="pi {{ fileService.getFileIcon(file.mime_type) }} text-lg text-[var(--color-text-muted)]"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-medium text-[var(--color-text)] truncate" [pTooltip]="file.name">{{ file.name }}
                    </h3>
                    <p class="text-xs text-[var(--color-text-muted)]">{{ fileService.formatFileSize(file.size_bytes) }}
                    </p>
                </div>
            </div>

            <!-- Meta -->
            <div class="flex items-center gap-2 mb-3 text-xs text-[var(--color-text-muted)]">
                <span>{{ file.created_at | date:'dd.MM.yyyy' }}</span>
                @if (file.uploader) {
                <span>• {{ file.uploader.name }}</span>
                }
            </div>

            <!-- Tags -->
            <div class="flex items-center gap-2 mb-3">
                <p-tag [value]="getVisibilityLabel(file.visibility)"
                    [severity]="$any(getVisibilitySeverity(file.visibility))" styleClass="!text-[10px] !px-2 !py-0.5" />
                @if (file.working_group) {
                <p-tag [value]="file.working_group.name" severity="secondary" styleClass="!text-[10px] !px-2 !py-0.5" />
                }
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 pt-3 border-t border-[var(--color-border)]">
                <button (click)="downloadFile(file)"
                    class="flex-1 py-1.5 rounded-lg text-xs font-medium bg-[var(--color-surface-raised)] hover:bg-linke/20 text-[var(--color-text)] transition-colors">
                    <i class="pi pi-download mr-1"></i>Download
                </button>
                @if (canDelete(file)) {
                <button (click)="confirmDelete(file)"
                    class="w-8 h-8 rounded-lg flex items-center justify-center text-[var(--color-text-muted)] hover:text-red-400 hover:bg-red-500/10 transition-colors">
                    <i class="pi pi-trash text-sm"></i>
                </button>
                }
            </div>
        </div>
        } @empty {
        <div class="col-span-full text-center py-16">
            <i class="pi pi-folder-open text-5xl text-[var(--color-text-muted)] mb-4"></i>
            <p class="text-[var(--color-text-muted)]">
                @if (isSearching()) {
                Keine Dateien gefunden.
                } @else {
                Dieser Ordner ist leer.
                }
            </p>
            <p-button label="Datei hochladen" icon="pi pi-upload" severity="secondary" [outlined]="true" size="small"
                (click)="openUploadDialog()" styleClass="mt-4" />
        </div>
        }
    </div>
    }
</div>

<!-- Upload Dialog -->
<p-dialog header="Datei hochladen" [(visible)]="uploadDialogVisible" [modal]="true" [draggable]="false"
    [resizable]="false" maskStyleClass="backdrop-blur-sm bg-black/50" [style]="{width: '500px', maxWidth: '95vw'}">

    <div class="space-y-4">
        <!-- File Upload -->
        <p-fileUpload mode="advanced" name="file" [auto]="false" [customUpload]="true"
            (uploadHandler)="handleUpload($event)" chooseLabel="Datei auswählen" uploadLabel="Hochladen"
            cancelLabel="Abbrechen" accept="*/*" [maxFileSize]="50000000"
            styleClass="[&_.p-fileupload-content]:bg-[var(--color-surface-raised)] [&_.p-fileupload-content]:border-[var(--color-border)]" />

        <!-- Visibility -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Sichtbarkeit</label>
            <p-select [options]="visibilityOptions" [(ngModel)]="uploadVisibility" optionLabel="label"
                optionValue="value" styleClass="w-full" />
        </div>

        <!-- Working Group (if AG-only) -->
        @if (uploadVisibility === 'ag-only') {
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Arbeitsgruppe</label>
            <p-select [options]="workingGroups()" [(ngModel)]="uploadWorkingGroupId" optionLabel="name" optionValue="id"
                placeholder="AG auswählen..." styleClass="w-full" />
        </div>
        }

        <!-- Description -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium">Beschreibung (optional)</label>
            <textarea pTextarea [(ngModel)]="uploadDescription" rows="2" placeholder="Kurze Beschreibung..."
                class="w-full"></textarea>
        </div>
    </div>
</p-dialog>