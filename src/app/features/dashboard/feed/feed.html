<p-toast></p-toast>
<div class="p-4 md:p-6 max-w-7xl mx-auto animate-fade-in">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-[var(--color-text)]">Aktuelles & Beiträge</h1>
            <p class="text-[var(--color-text-muted)] text-sm mt-1">Neuigkeiten und Artikel aus der Community</p>
        </div>
        @if (canCreate()) {
        <p-button label="Neuer Beitrag" icon="pi pi-plus" (click)="openNew()" severity="primary"
            [raised]="true"></p-button>
        }
    </div>

    <!-- Notification Onboarding Banner -->
    @if (notificationService.permissionStatus() === 'default' && notificationService.isSupported()) {
    <div
        class="mb-6 p-4 rounded-xl bg-gradient-to-r from-teal-500/10 to-blue-500/10 border border-teal-500/20 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 animate-fadein">
        <div class="flex items-center gap-4">
            <div
                class="w-10 h-10 rounded-full bg-[var(--color-surface)] flex items-center justify-center border border-teal-500/30 shadow-sm shrink-0">
                <i class="pi pi-bell text-teal-500 text-lg"></i>
            </div>
            <div>
                <h3 class="font-bold text-[var(--color-text)]">Nichts Wichtiges verpassen</h3>
                <p class="text-sm text-[var(--color-text-muted)]">Erhalte Benachrichtigungen bei neuen Beiträgen &
                    Terminen.</p>
            </div>
        </div>
        <p-button label="Aktivieren" icon="pi pi-check" (click)="enableNotifications()" size="small" [raised]="true"
            severity="info"></p-button>
    </div>
    }

    <p-tabs value="0">
        <p-tablist>
            <p-tab value="0">Aktuelles</p-tab>
            <p-tab value="1" *ngIf="auth.isMember()">Meine Beiträge</p-tab>
            <p-tab value="2" *ngIf="canApprove()">Verwaltung</p-tab>
        </p-tablist>

        <p-tabpanels>
            <!-- Tab 1: Feed (Öffentlich/Approved) -->
            <p-tabpanel value="0">
                <div class="grid gap-6">
                    @for (item of feedItems(); track item.id) {
                    <div
                        class="bg-[var(--color-surface-card)] rounded-xl border border-[var(--color-border)] overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                        <div class="p-6">
                            <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
                                <div>
                                    <h2 class="text-xl font-bold text-[var(--color-text)] mb-2">{{ item.title }}</h2>
                                    <div class="flex items-center gap-2 text-sm text-[var(--color-text-muted)]">
                                        <i class="pi pi-calendar"></i>
                                        <span>{{ item.created_at | date:'dd.MM.yyyy' }}</span>
                                        <span>•</span>
                                        <i class="pi pi-user"></i>
                                        <span>{{ item.author?.name || 'Unbekannt' }}</span>
                                        <p-tag [value]="item.type === 'link' ? 'Link' : 'Artikel'" severity="info"
                                            styleClass="text-xs ml-2"></p-tag>
                                    </div>
                                </div>
                                <div *ngIf="item.status === 'sent'"
                                    class="text-xs text-green-500 font-medium border border-green-500/20 bg-green-500/10 px-2 py-1 rounded">
                                    <i class="pi pi-check"></i> Newsletter versendet
                                </div>
                            </div>

                            <div class="prose prose-sm max-w-none text-[var(--color-text)] leading-relaxed">
                                @if (item.type === 'link') {
                                <a [href]="item.url" target="_blank" class="block group mt-1 mb-4 no-underline">
                                    <div
                                        class="p-3 rounded-lg bg-[var(--color-surface-ground)] border border-[var(--color-border)] group-hover:border-[var(--linke)] transition-all flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-full bg-[var(--color-surface-raised)] flex items-center justify-center shrink-0 border border-[var(--color-border)]">
                                            <i
                                                class="pi pi-link text-[var(--color-text-muted)] group-hover:text-[var(--linke)] transition-colors"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div
                                                class="text-sm font-medium truncate text-[var(--linke)] group-hover:underline">
                                                {{ item.url }}</div>
                                            <div class="text-xs text-[var(--color-text-muted)]">Externer Link</div>
                                        </div>
                                        <i
                                            class="pi pi-external-link text-[var(--color-text-muted)] opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                    </div>
                                </a>
                                @if (item.content) {
                                <div class="pl-2 border-l-2 border-[var(--color-border)] text-sm text-[var(--color-text-muted)] italic"
                                    [innerHTML]="item.content"></div>
                                }
                                } @else if (item.type === 'poll') {
                                <div class="mb-4" [innerHTML]="item.content"></div>
                                <div class="space-y-2 max-w-lg">
                                    @for (option of item.poll_options; track option.id) {
                                    <div class="relative p-3 rounded-lg border border-[var(--color-border)] cursor-pointer hover:bg-[var(--color-surface-hover)] transition-all overflow-hidden"
                                        (click)="vote(item, option.id)">
                                        <!-- Progress Bar Background -->
                                        <div class="absolute inset-0 bg-[var(--primary-color)] opacity-10 transition-all duration-500"
                                            [style.width.%]="getVotePercentage(item, option.id)"></div>

                                        <div class="flex justify-between items-center relative z-10">
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full border border-[var(--color-text-muted)] flex items-center justify-center transition-colors"
                                                    [class.bg-[var(--primary-color)]]="hasVotedFor(item, option.id)"
                                                    [class.border-[var(--primary-color)]]="hasVotedFor(item, option.id)">
                                                    <i class="pi pi-check text-white text-xs"
                                                        *ngIf="hasVotedFor(item, option.id)"></i>
                                                </div>
                                                <span class="font-medium text-[var(--color-text)]">{{ option.text
                                                    }}</span>
                                            </div>
                                            <span class="text-xs font-bold text-[var(--color-text-muted)]"
                                                *ngIf="getTotalVotes(item) > 0">
                                                {{ getVotePercentage(item, option.id) }}%
                                            </span>
                                        </div>
                                    </div>
                                    }
                                    <div
                                        class="flex justify-end items-center mt-2 text-xs text-[var(--color-text-muted)]">
                                        <span>{{ getTotalVotes(item) }} Stimmen</span>
                                    </div>
                                </div>
                                } @else {
                                <div [innerHTML]="item.content"></div>
                                }
                            </div>
                        </div>
                    </div>
                    }
                    @if (feedItems().length === 0) {
                    <div
                        class="flex flex-col items-center justify-center py-16 text-[var(--color-text-muted)] bg-[var(--color-surface-raised)] rounded-xl border border-[var(--color-border)] border-dashed">
                        <i class="pi pi-inbox text-4xl mb-3 opacity-50"></i>
                        <p>Keine Beiträge vorhanden.</p>
                    </div>
                    }
                </div>
            </p-tabpanel>

            <!-- Tab 2: Meine Beiträge -->
            <p-tabpanel value="1" *ngIf="auth.isMember()">
                <div class="space-y-4">
                    @for (item of myItems(); track item.id) {
                    <div
                        class="bg-[var(--color-surface-card)] p-4 rounded-lg border border-[var(--color-border)] flex flex-col md:flex-row gap-4 justify-between items-start md:items-center hover:bg-[var(--color-surface-overlay)] transition-colors">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <h3 class="font-bold text-lg truncate">{{ item.title }}</h3>
                                <p-tag [value]="item.status" [severity]="getStatusSeverity(item.status)"></p-tag>
                            </div>
                            <div class="text-sm text-[var(--color-text-muted)] flex items-center gap-2">
                                <span>{{ item.created_at | date:'dd.MM.yyyy HH:mm' }}</span>
                                <span>•</span>
                                <span class="capitalize">{{ item.type }}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            @if (item.status === 'draft') {
                            <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" (click)="openEdit(item)"
                                pTooltip="Bearbeiten" tooltipPosition="top"></p-button>
                            <p-button icon="pi pi-send" [text]="true" [rounded]="true" severity="success"
                                (click)="submitForReview(item)" pTooltip="Zur Prüfung einreichen"
                                tooltipPosition="top"></p-button>
                            <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
                                (click)="deleteItem(item)" pTooltip="Löschen" tooltipPosition="top"></p-button>
                            } @else {
                            <p-button icon="pi pi-eye" [text]="true" [rounded]="true" (click)="openEdit(item)"
                                pTooltip="Ansehen" tooltipPosition="top"></p-button>
                            }
                        </div>
                    </div>
                    }
                    @if (myItems().length === 0) {
                    <div class="text-center text-[var(--color-text-muted)] py-8">Du hast noch keine Beiträge verfasst.
                    </div>
                    }
                </div>
            </p-tabpanel>

            <!-- Tab 3: Verwaltung (Admin/Approver) -->
            <p-tabpanel value="2" *ngIf="canApprove()">
                <div class="space-y-6">

                    <!-- Sub Navigation -->
                    <div class="flex justify-center md:justify-start">
                        <p-selectButton [options]="adminViewOptions" [(ngModel)]="adminView" optionLabel="label"
                            optionValue="value" [allowEmpty]="false"></p-selectButton>
                    </div>


                    <!-- View: Review -->
                    <div *ngIf="adminView() === 'review'" class="animate-fade-in space-y-4">
                        <div class="flex items-center gap-2 text-amber-500 bg-amber-500/10 p-3 rounded-lg border border-amber-500/20 mb-4"
                            *ngIf="reviewItems().length > 0">
                            <i class="pi pi-info-circle"></i>
                            <span class="font-medium font-sm">{{ reviewItems().length }} Beiträge warten auf
                                Freigabe.</span>
                        </div>

                        @for (item of reviewItems(); track item.id) {
                        <div
                            class="bg-[var(--color-surface-card)] p-5 rounded-lg border border-l-4 border-l-amber-500 border-[var(--color-border)] flex flex-col gap-4 shadow-sm">
                            <div class="flex justify-between items-start flex-wrap gap-4">
                                <div>
                                    <div class="font-bold text-lg">{{ item.title }}</div>
                                    <div class="text-sm text-[var(--color-text-muted)] mt-1">Von: <span
                                            class="font-medium text-[var(--color-text)]">{{ item.author?.name }}</span>
                                        • {{ item.created_at | date:'short' }}</div>
                                </div>
                                <div class="flex gap-2">
                                    <p-button label="Freigeben" icon="pi pi-check" severity="success" size="small"
                                        [raised]="true" (click)="approveItem(item)"></p-button>
                                    <p-button label="Bearbeiten" icon="pi pi-pencil" severity="secondary" size="small"
                                        [outlined]="true" (click)="openEdit(item)"></p-button>
                                </div>
                            </div>
                            <div
                                class="bg-[var(--color-bg)] p-4 rounded border border-[var(--color-border)] text-sm max-h-60 overflow-y-auto">
                                <div [innerHTML]="item.content"></div>
                                @if (item.url) {
                                <div class="mt-3 pt-3 border-t border-[var(--color-border)]">
                                    <a [href]="item.url" target="_blank"
                                        class="text-linke hover:underline flex items-center gap-1">
                                        {{ item.url }} <i class="pi pi-external-link text-xs"></i>
                                    </a>
                                </div>
                                }
                            </div>
                        </div>
                        }
                        @if (reviewItems().length === 0) {
                        <div class="flex flex-col items-center justify-center py-12 text-[var(--color-text-muted)]">
                            <i class="pi pi-check-circle text-4xl mb-3 text-green-500/50"></i>
                            <p>Alles erledigt! Keine Einträge zur Prüfung.</p>
                        </div>
                        }
                    </div>

                    <!-- View: Sent (History) -->
                    <div *ngIf="adminView() === 'sent'" class="animate-fade-in space-y-4">
                        @for (item of sentItems(); track item.id) {
                        <div
                            class="bg-[var(--color-surface-card)] p-4 rounded-lg border border-[var(--color-border)] flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center flex-wrap gap-2 mb-1">
                                    <h3 class="font-bold text-lg truncate">{{ item.title }}</h3>
                                    <p-tag value="Versendet" severity="info"></p-tag>
                                    <p-tag [value]="item.type" severity="secondary"></p-tag>
                                </div>
                                <div class="text-sm text-[var(--color-text-muted)] flex items-center gap-2">
                                    <i class="pi pi-envelope text-xs"></i>
                                    <span>Versendet am: {{ item.sent_at | date:'dd.MM.yyyy HH:mm' }}</span>
                                    <span>•</span>
                                    <span>Von {{ item.author?.name }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <p-button icon="pi pi-eye" [text]="true" [rounded]="true" (click)="openEdit(item)"
                                    pTooltip="Ansehen" tooltipPosition="top"></p-button>
                            </div>
                        </div>
                        }
                        @if (sentItems().length === 0) {
                        <div class="text-center text-[var(--color-text-muted)] py-8">Keine Einträge im Archiv.</div>
                        }
                    </div>

                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>

    <!-- Test Email Dialog -->
    <p-dialog [(visible)]="testEmailDialogVisible" header="Newsletter Vorschau senden" [modal]="true"
        [style]="{width: '400px'}" [resizable]="false">
        <div class="flex flex-col gap-4 pt-2">
            <p class="text-[var(--color-text-muted)] text-sm">Sendet eine Vorschau aller aktuellen Beiträge an die
                angegebene Adresse, ohne den Status "Versendet" zu setzen.</p>
            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm">E-Mail Adresse</label>
                <input pInputText [(ngModel)]="testEmail" placeholder="name@beispiel.de" class="w-full"
                    (keydown.enter)="sendTest()" />
            </div>
        </div>
        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2 pt-4">
                <p-button label="Abbrechen" (click)="testEmailDialogVisible.set(false)" [text]="true"
                    severity="secondary"></p-button>
                <p-button label="Senden" icon="pi pi-send" (click)="sendTest()" [raised]="true"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Create/Edit Dialog remains same -->
    <p-dialog [(visible)]="dialogVisible" [header]="editMode() ? 'Beitrag bearbeiten' : 'Neuer Beitrag'" [modal]="true"
        [style]="{width: '90vw', maxWidth: '800px'}" [maximizable]="true" [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-5 pt-2">

            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Beitragstyp</label>
                <p-selectButton [options]="typeOptions" [(ngModel)]="currentItem.type" optionLabel="label"
                    optionValue="value" [disabled]="editMode()"></p-selectButton>
            </div>

            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Titel</label>
                <input pInputText [(ngModel)]="currentItem.title" placeholder="Titel des Beitrags" class="w-full" />
            </div>

            @if (currentItem.type === 'link') {
            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Link-URL</label>
                <input pInputText [(ngModel)]="currentItem.url" placeholder="https://..." class="w-full" />
            </div>
            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Beschreibung / Kommentar
                    (Optional)</label>
                <p-editor [(ngModel)]="currentItem.content" [style]="{height: '150px'}"
                    placeholder="Beschreibe den Link kurz..."></p-editor>
            </div>
            } @else if (currentItem.type === 'poll') {
            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Frage / Beschreibung</label>
                <p-editor [(ngModel)]="currentItem.content" [style]="{height: '100px'}"
                    placeholder="Worum geht es in der Abstimmung?"></p-editor>
            </div>

            <div class="flex flex-col gap-3">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Antwortmöglichkeiten</label>
                <div class="flex flex-col gap-2">
                    @for (opt of pollOptions(); track $index) {
                    <div class="flex gap-2 items-center animate-fadein">
                        <div
                            class="w-6 h-6 rounded-full border border-[var(--color-border)] flex items-center justify-center shrink-0 bg-[var(--color-surface-ground)] text-xs text-[var(--color-text-muted)]">
                            {{$index + 1}}
                        </div>
                        <input pInputText [ngModel]="opt" (ngModelChange)="updatePollOption($index, $event)"
                            [placeholder]="'Option ' + ($index + 1)" class="flex-1" />
                        <p-button icon="pi pi-trash" [text]="true" severity="danger" (click)="removePollOption($index)"
                            [disabled]="pollOptions().length <= 2" pTooltip="Entfernen"></p-button>
                    </div>
                    }
                </div>
                <div>
                    <p-button label="Option hinzufügen" icon="pi pi-plus" [text]="true" size="small"
                        (click)="addPollOption()"></p-button>
                </div>
            </div>
            } @else {
            <div class="flex flex-col gap-2">
                <label class="font-medium text-sm text-[var(--color-text-muted)]">Artikelinhalt</label>
                <p-editor [(ngModel)]="currentItem.content" [style]="{height: '400px'}"
                    placeholder="Schreibe hier deinen Artikel..."></p-editor>
            </div>
            }
        </div>
        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2 pt-4">
                <p-button label="Abbrechen" icon="pi pi-times" [text]="true" (click)="dialogVisible.set(false)"
                    severity="secondary"></p-button>
                <p-button label="Speichern" icon="pi pi-check" (click)="saveItem()" [raised]="true"></p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>