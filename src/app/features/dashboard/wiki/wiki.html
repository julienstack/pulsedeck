<p-toast />
<p-confirmDialog />

<div class="flex flex-col lg:flex-row gap-4 h-full">
    <!-- Left Panel: Categories & Article List -->
    <div class="lg:w-72 xl:w-80 flex-shrink-0 flex flex-col">
        <!-- Header & New Button -->
        <div class="flex items-center justify-between mb-3">
            <div>
                <h1 class="text-xl font-bold text-[var(--color-text)]">Wiki</h1>
                <p class="text-xs text-[var(--color-text-muted)] hidden md:block">Wissensdatenbank</p>
            </div>
            @if (canEdit()) {
            <p-button icon="pi pi-plus" severity="danger" [rounded]="true" size="small" pTooltip="Neuer Artikel"
                (click)="openNew()"></p-button>
            }
        </div>

        <!-- Search -->
        <div class="relative mb-3">
            <i class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--color-text-muted)] text-xs"></i>
            <input pInputText type="text" (input)="onSearch($event)" placeholder="Suchen..."
                class="w-full pl-8 py-1.5 text-sm !bg-[var(--color-surface-raised)] !border-[var(--color-border)] rounded-lg" />
        </div>

        <!-- Categories (Accordion Style) -->
        <div
            class="bg-[var(--color-surface)]/50 border border-[var(--color-border)] rounded-xl overflow-hidden flex-1 flex flex-col min-h-0">
            <!-- All Articles -->
            <button (click)="filterCategory(null)"
                [class]="selectedCategory() === null ? 'bg-[var(--color-surface-raised)] border-l-2 border-l-linke font-medium' : 'border-l-2 border-l-transparent hover:bg-[var(--color-surface-raised)]'"
                class="w-full text-left p-2.5 flex items-center justify-between text-sm transition-colors">
                <span class="flex items-center gap-2">
                    <i class="pi pi-folder text-[var(--color-text-muted)] text-xs"></i>
                    <span
                        [class]="selectedCategory() === null ? 'text-[var(--color-text)]' : 'text-[var(--color-text-muted)]'">Alle
                        Artikel</span>
                </span>
                <span
                    class="text-[10px] bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-1.5 py-0.5 rounded-full">{{docs().length}}</span>
            </button>

            <!-- Category Sections -->
            @for (cat of ['General', 'Finance', 'Tech', 'Legal']; track cat) {
            <div class="border-t border-[var(--color-border)]">
                <button (click)="toggleCategory(cat)"
                    [class]="selectedCategory() === cat ? 'bg-[var(--color-surface-raised)] border-l-2 border-l-linke font-medium' : 'border-l-2 border-l-transparent hover:bg-[var(--color-surface-raised)]'"
                    class="w-full text-left p-2.5 flex items-center justify-between text-sm transition-colors">
                    <span class="flex items-center gap-2">
                        <i class="pi text-xs" [ngClass]="{
                            'pi-info-circle text-[var(--color-text-muted)]': cat === 'General',
                            'pi-dollar text-[var(--color-text-muted)]': cat === 'Finance',
                            'pi-cog text-[var(--color-text-muted)]': cat === 'Tech',
                            'pi-shield text-[var(--color-text-muted)]': cat === 'Legal'
                        }"></i>
                        <span
                            [class]="selectedCategory() === cat ? 'text-[var(--color-text)]' : 'text-[var(--color-text-muted)]'">
                            {{getCategoryLabel(cat)}}
                        </span>
                    </span>
                    <div class="flex items-center gap-1.5">
                        <span
                            class="text-[10px] bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-1.5 py-0.5 rounded-full">{{getCountByCategory(cat)}}</span>
                        <i class="pi text-[10px] text-[var(--color-text-muted)]"
                            [class]="expandedCategories[cat] ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                    </div>
                </button>

                <!-- Articles in Category -->
                @if (expandedCategories[cat]) {
                <div class="bg-[var(--color-surface-raised)]/30">
                    @for (doc of getDocsByCategory(cat); track doc.id) {
                    <button (click)="selectArticle(doc)"
                        [class]="selectedArticle()?.id === doc.id ? 'bg-gray-700/50 text-[var(--color-text)]' : 'text-[var(--color-text-muted)] hover:bg-[var(--color-surface-raised)] hover:text-gray-200'"
                        class="w-full text-left px-4 py-2 text-xs border-l-2 border-l-transparent transition-colors truncate flex items-center gap-2">
                        <i class="pi pi-file text-[10px]"></i>
                        <span class="truncate">{{doc.title}}</span>
                    </button>
                    } @empty {
                    <div class="px-4 py-2 text-xs text-[var(--color-text-muted)] italic">Keine Artikel</div>
                    }
                </div>
                }
            </div>
            }

            <!-- AG Wikis -->
            @if (myAgs().length > 0) {
            <div class="border-t border-[var(--color-border)] mt-2 pt-2">
                <div class="px-2.5 py-1 text-[10px] font-bold text-[var(--color-text-muted)] uppercase tracking-wider">
                    Arbeitsgruppen
                </div>
                @for (ag of myAgs(); track ag.id) {
                <div>
                    <button (click)="toggleCategory('AG:' + ag.id!)"
                        [class]="selectedCategory() === 'AG:' + ag.id ? 'bg-[var(--color-surface-raised)] border-l-2 border-l-purple-500 font-medium' : 'border-l-2 border-l-transparent hover:bg-[var(--color-surface-raised)]'"
                        class="w-full text-left p-2.5 flex items-center justify-between text-sm transition-colors">
                        <span class="flex items-center gap-2">
                            <i class="pi pi-users text-[var(--color-text-muted)] text-xs"></i>
                            <span
                                [class]="selectedCategory() === 'AG:' + ag.id ? 'text-[var(--color-text)]' : 'text-[var(--color-text-muted)]'">
                                {{ag.name}}
                            </span>
                        </span>
                        <div class="flex items-center gap-1.5">
                            <span
                                class="text-[10px] bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-1.5 py-0.5 rounded-full">{{getCountByCategory('AG:'
                                +
                                ag.id!)}}</span>
                            <i class="pi text-[10px] text-[var(--color-text-muted)]"
                                [class]="expandedCategories['AG:' + ag.id!] ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                        </div>
                    </button>

                    <!-- Articles in AG -->
                    @if (expandedCategories['AG:' + ag.id!]) {
                    <div class="bg-[var(--color-surface-raised)]/30">
                        @for (doc of getDocsByCategory('AG:' + ag.id!); track doc.id) {
                        <button (click)="selectArticle(doc)"
                            [class]="selectedArticle()?.id === doc.id ? 'bg-gray-700/50 text-[var(--color-text)]' : 'text-[var(--color-text-muted)] hover:bg-[var(--color-surface-raised)] hover:text-gray-200'"
                            class="w-full text-left px-4 py-2 text-xs border-l-2 border-l-transparent transition-colors truncate flex items-center gap-2">
                            <i class="pi pi-file text-[10px]"></i>
                            <span class="truncate">{{doc.title}}</span>
                        </button>
                        } @empty {
                        <div class="px-4 py-2 text-xs text-[var(--color-text-muted)] italic">Keine Artikel</div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>

    <!-- Right Panel: Article Content -->
    <div class="flex-1 min-w-0 flex flex-col">
        @if (loading()) {
        <div class="flex-1 flex items-center justify-center">
            <p-progressSpinner strokeWidth="4" ariaLabel="Lade..." />
        </div>
        } @else if (selectedArticle()) {
        <!-- Article View -->
        <div
            class="bg-[var(--color-surface)]/50 border border-[var(--color-border)] rounded-xl flex-1 flex flex-col overflow-hidden">
            <!-- Article Header -->
            <div class="p-4 border-b border-[var(--color-border)] flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <h2 class="text-lg font-bold text-[var(--color-text)] truncate">{{selectedArticle()!.title}}</h2>
                    <p class="text-sm text-[var(--color-text-muted)] mt-0.5 line-clamp-2">
                        {{selectedArticle()!.description}}</p>
                    <div class="flex items-center gap-3 mt-2 text-xs text-[var(--color-text-muted)]">
                        <span class="flex items-center gap-1">
                            <i class="pi pi-user text-[10px]"></i>
                            {{selectedArticle()!.author}}
                        </span>
                        <p-tag [value]="getCategoryLabel(selectedArticle()!.category)"
                            [severity]="getCategorySeverity(selectedArticle()!.category)"
                            styleClass="!text-[10px] !px-1.5 !py-0.5"></p-tag>
                        <span class="flex items-center gap-1">
                            <i class="pi text-[10px]" [ngClass]="{
                                'pi-check-circle text-green-500': selectedArticle()!.status === 'Published',
                                'pi-file text-yellow-500': selectedArticle()!.status === 'Draft',
                                'pi-eye text-teal': selectedArticle()!.status === 'Review'
                            }"></i>
                            {{getStatusLabel(selectedArticle()!.status)}}
                        </span>
                    </div>
                </div>
                @if (canEdit()) {
                <div class="flex items-center gap-1 flex-shrink-0">
                    <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" severity="secondary" size="small"
                        pTooltip="Bearbeiten" (click)="editDoc(selectedArticle()!)"></p-button>
                    <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger" size="small"
                        pTooltip="Löschen" (click)="confirmDelete(selectedArticle()!)"></p-button>
                </div>
                }
            </div>

            <!-- Article Content -->
            <div class="flex-1 overflow-y-auto p-4">
                @if (selectedArticle()!.content) {
                <div class="prose prose-invert prose-sm max-w-none">
                    <div class="text-[var(--color-text)] whitespace-pre-wrap leading-relaxed">
                        {{selectedArticle()!.content}}</div>
                </div>
                } @else {
                <div class="text-[var(--color-text-muted)] italic text-sm">Kein Inhalt verfügbar.</div>
                }
            </div>
        </div>
        } @else {
        <!-- Empty State - No Article Selected -->
        <div
            class="flex-1 flex items-center justify-center bg-[var(--color-surface)]/30 border border-[var(--color-border)] rounded-xl">
            <div class="text-center">
                <i class="pi pi-book text-4xl text-[var(--color-text-muted)] mb-3"></i>
                <p class="text-[var(--color-text-muted)] text-sm">Wähle einen Artikel aus der Liste</p>
                @if (canEdit()) {
                <p-button label="Neuen Artikel erstellen" icon="pi pi-plus" [text]="true" size="small" styleClass="mt-3"
                    (click)="openNew()"></p-button>
                }
            </div>
        </div>
        }
    </div>
</div>

<!-- Wiki Dialog -->
<p-dialog [header]="editMode() ? 'Artikel bearbeiten' : 'Neuer Artikel'" [visible]="dialogVisible()"
    (visibleChange)="dialogVisible.set($event)" [modal]="true" [draggable]="false" [resizable]="false"
    maskStyleClass="backdrop-blur-sm bg-black/50" [style]="{width: '700px', maxWidth: '95vw'}" [closable]="!saving()">
    <div class="space-y-3">
        <div>
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Titel *</label>
            <input pInputText [(ngModel)]="currentDoc.title" class="w-full" placeholder="Artikeltitel" />
        </div>
        <div>
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Beschreibung *</label>
            <input pInputText [(ngModel)]="currentDoc.description" class="w-full" placeholder="Kurzbeschreibung" />
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Kategorie</label>
                <p-select [(ngModel)]="currentDoc.category" [options]="categoryOptions" optionLabel="label"
                    optionValue="value" styleClass="w-full" />
            </div>
            <div>
                <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Status</label>
                <p-select [(ngModel)]="currentDoc.status" [options]="statusOptions()" optionLabel="label"
                    optionValue="value" styleClass="w-full" />
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Sichtbarkeit</label>
            <p-select [(ngModel)]="tempVisibility" [options]="visibilityOptions" optionLabel="label" optionValue="value"
                styleClass="w-full" />
        </div>
        <div>
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Autor</label>
            <input pInputText [(ngModel)]="currentDoc.author" class="w-full" placeholder="Dein Name" />
        </div>
        <div>
            <label class="block text-sm font-medium text-[var(--color-text)] mb-1">Inhalt</label>
            <textarea pTextarea [(ngModel)]="currentDoc.content" class="w-full" rows="8"
                placeholder="Inhalt..."></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Abbrechen" severity="secondary" [text]="true" (click)="dialogVisible.set(false)"
            [disabled]="saving()" />
        <p-button [label]="editMode() ? 'Speichern' : 'Erstellen'" icon="pi pi-check" (click)="saveDoc()"
            [loading]="saving()" />
    </ng-template>
</p-dialog>